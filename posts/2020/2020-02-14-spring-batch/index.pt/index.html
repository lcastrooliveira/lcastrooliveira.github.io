<!DOCTYPE html><html lang="en-US"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" property="og:description" content="Como fazer um ELT bem simples para converter dados CSV para um banco usando Spring Batch"/><meta data-react-helmet="true" property="og:locale" content="en"/><meta data-react-helmet="true" property="og:url" content="https://lcastrooliveira.dev/posts/2020/2020-02-14-spring-batch/index.pt/"/><meta data-react-helmet="true" property="og:title" content="Usando Spring Batch para fazer ETL de informaçoes financeiras | lcastrooliveira.dev"/><meta data-react-helmet="true" property="og:updated_time" content="2019-01-31"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:image:height" content="315"/><meta data-react-helmet="true" property="og:image:width" content="600"/><meta data-react-helmet="true" property="og:image" content="data:image/png;base64,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"/><meta data-react-helmet="true" property="og:locale:alternate" content="pt_BR"/><meta name="generator" content="Gatsby 4.12.1"/><style data-href="/styles.bc6c8b49feb7826f5fb7.css" data-identity="gatsby-global-css">.sidebar-btns{background-color:transparent;background-color:#8a2be2;background-position:50%;background-repeat:no-repeat;border:none;border-radius:.25rem;bottom:50px;color:#fff;cursor:pointer;display:none;font-size:1.125rem;height:50px;outline:none;padding:.9375rem;position:fixed;right:10%;width:50px;z-index:99}#scroll-btn,.sidebar-btns{background-image:url(/arrow-up.svg)}#scroll-btn{background-color:#461587;right:15%}.listStyle{background-color:#fff;border-radius:2px;list-style-type:none;margin:0;padding:0;position:absolute}.listItemStyle{padding:.5em;position:relative}.listItemStyle:hover{background-color:#aca2a2}.listItemStyle a{color:#000}.listItemStyle a,a{text-decoration:none}a{color:#fff}.languageSelector{background-color:#bababa;border-radius:2px;color:#000;display:inline-block;margin:0 .4em!important;padding:.5em;text-align:center;text-decoration:none}.languageSelectorSelected{border:3px solid gray}.article a{color:#000;text-decoration:none}.article:hover{background-color:#aca2a2}</style><title data-react-helmet="true">Usando Spring Batch para fazer ETL de informaçoes financeiras</title><link data-react-helmet="true" rel="alternate" hrefLang="x-default" href="https://lcastrooliveira.dev"/><link data-react-helmet="true" rel="alternate" hrefLang="en-US" href="https://lcastrooliveira.dev/posts/2020/2020-02-14-spring-batch/index.pt/"/><link data-react-helmet="true" rel="alternate" hrefLang="pt-BR" href="https://lcastrooliveira.dev/pt/posts/2020/2020-02-14-spring-batch/index.pt/"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-162076837-1"></script><script>
      
      function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-162076837-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
      if(!(navigator.doNotTrack == "1" || window.doNotTrack == "1")) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-162076837-1', {"anonymize_ip":true,"send_page_view":false});
      }
      </script><link as="script" rel="preload" href="/webpack-runtime-559f8e6fdcf32331fb71.js"/><link as="script" rel="preload" href="/framework-d48bb74d9b35d2fed097.js"/><link as="script" rel="preload" href="/dbf3ce33-e9860c7ab2c3d4ec26ae.js"/><link as="script" rel="preload" href="/app-bad2ce8103fa8906b2df.js"/><link as="script" rel="preload" href="/99b7119fd52cd3d90c1cdad208f938f090fd7adb-5239dbe11e8a53b8d362.js"/><link as="script" rel="preload" href="/95d32b32e96a6247500d795b14d67e6354a04d89-f51203b5a3fe19078cf0.js"/><link as="script" rel="preload" href="/component---src-templates-post-page-template-js-1473b82cdc2fba7001af.js"/><link as="fetch" rel="preload" href="/page-data/posts/2020/2020-02-14-spring-batch/index.pt/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1239077767.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2744294623.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2744905544.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3280999885.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/4024388462.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.documentElement.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion="css-global 3b8a9z">html{--theme-ui-colors-text:#000;--theme-ui-colors-background:#bababa;--theme-ui-colors-primary:#1f1f22;--theme-ui-colors-secondary:#461587;--theme-ui-colors-muted:#b1b1b1;color:var(--theme-ui-colors-text);background-color:var(--theme-ui-colors-background);}</style><style data-emotion="css-global h19pgh">*{box-sizing:border-box;}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.5;font-weight:400;}body{margin:0;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css 12hlzpf">.css-12hlzpf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;}</style><div class="css-12hlzpf"><div></div><style data-emotion="css 1tsye3q">.css-1tsye3q{box-sizing:border-box;margin:0;min-width:0;padding:8px;color:white;background-color:var(--theme-ui-colors-primary);}</style><div class="css-1tsye3q"><style data-emotion="css 7a2w9v">.css-7a2w9v{display:grid;grid-gap:16px;max-width:1024px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:16px;padding-bottom:16px;grid-auto-flow:row;grid-template-columns:repeat(2, 1fr);}@media screen and (min-width: 40em){.css-7a2w9v{grid-template-columns:repeat(3, 1fr);}}</style><header class="css-7a2w9v"><style data-emotion="css 1s1w6s">.css-1s1w6s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;grid-column-start:1;grid-column-end:3;-webkit-order:0;-ms-flex-order:0;order:0;}@media screen and (min-width: 40em){.css-1s1w6s{grid-column-start:2;grid-column-end:3;-webkit-order:1;-ms-flex-order:1;order:1;}}</style><div class="css-1s1w6s"><a title="Home" href="/"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained"><div style="max-width:598px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg height=&#x27;103&#x27; width=&#x27;598&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#080808;position:absolute;top:0;left:0;bottom:0;right:0"></div><picture><source type="image/webp" data-srcset="/static/95b27f7aa5ab05df16e73830a5825efb/88084/blog-logo.webp 150w,/static/95b27f7aa5ab05df16e73830a5825efb/a065b/blog-logo.webp 299w,/static/95b27f7aa5ab05df16e73830a5825efb/47bfd/blog-logo.webp 598w" sizes="(min-width: 598px) 598px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 598px) 598px, 100vw" decoding="async" loading="lazy" data-src="/static/95b27f7aa5ab05df16e73830a5825efb/5efe8/blog-logo.png" data-srcset="/static/95b27f7aa5ab05df16e73830a5825efb/490e4/blog-logo.png 150w,/static/95b27f7aa5ab05df16e73830a5825efb/b2981/blog-logo.png 299w,/static/95b27f7aa5ab05df16e73830a5825efb/5efe8/blog-logo.png 598w" alt="Blog Logo"/></picture><noscript><picture><source type="image/webp" srcSet="/static/95b27f7aa5ab05df16e73830a5825efb/88084/blog-logo.webp 150w,/static/95b27f7aa5ab05df16e73830a5825efb/a065b/blog-logo.webp 299w,/static/95b27f7aa5ab05df16e73830a5825efb/47bfd/blog-logo.webp 598w" sizes="(min-width: 598px) 598px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 598px) 598px, 100vw" decoding="async" loading="lazy" src="/static/95b27f7aa5ab05df16e73830a5825efb/5efe8/blog-logo.png" srcSet="/static/95b27f7aa5ab05df16e73830a5825efb/490e4/blog-logo.png 150w,/static/95b27f7aa5ab05df16e73830a5825efb/b2981/blog-logo.png 299w,/static/95b27f7aa5ab05df16e73830a5825efb/5efe8/blog-logo.png 598w" alt="Blog Logo"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1)}}</script></div><style data-emotion="css 1an41nv">.css-1an41nv{position:absolute;width:1px;height:1px;overflow:hidden;top:-9999px;}</style><span class="css-1an41nv">Home</span></a></div><style data-emotion="css 17pk10b">.css-17pk10b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;}</style><div class="css-17pk10b"><style data-emotion="css 1sg9vzq">.css-1sg9vzq{padding:8px;}</style><a class="css-1sg9vzq" href="/about">About</a><a class="css-1sg9vzq" href="/contact">Contact</a><style data-emotion="css vry94m">.css-vry94m{box-sizing:border-box;margin:0;min-width:0;color:#fff;-webkit-text-decoration:none;text-decoration:none;}</style><a href="/" class="languageSelector languageSelectorSelected css-vry94m">EN</a><a href="/pt" class="languageSelector  css-vry94m">PT</a></div><style data-emotion="css 1lx7s8t">.css-1lx7s8t{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;-webkit-order:2;-ms-flex-order:2;order:2;}</style><div class="css-1lx7s8t"><div><style data-emotion="css dlo3m6">.css-dlo3m6{box-sizing:border-box;margin:0;min-width:0;display:block;width:100%;padding:8px;-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;font-size:inherit;line-height:inherit;border:1px solid;border-radius:4px;color:inherit;background-color:transparent;--theme-ui-input-autofill-bg:var(--theme-ui-colors-background);}.css-dlo3m6:autofill,.css-dlo3m6:autofill:hover,.css-dlo3m6:autofill:focus{box-shadow:inset 0 0 0 1000px var(--theme-ui-input-autofill-bg);font-size:inherit;}.css-dlo3m6:autofill:first-line,.css-dlo3m6:autofill:hover:first-line,.css-dlo3m6:autofill:focus:first-line{font-size:1rem;}.css-dlo3m6:-webkit-autofill,.css-dlo3m6:-webkit-autofill:hover,.css-dlo3m6:-webkit-autofill:focus{box-shadow:inset 0 0 0 1000px var(--theme-ui-input-autofill-bg);font-size:inherit;}.css-dlo3m6:-webkit-autofill:first-line,.css-dlo3m6:-webkit-autofill:hover:first-line,.css-dlo3m6:-webkit-autofill:focus:first-line{font-size:1rem;}</style><input placeholder="Search an article" value="" style="background-color:#fff;color:#000" class="css-dlo3m6"/></div></div></header></div><style data-emotion="css 1kfqeof">.css-1kfqeof{width:100%;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><main class="css-1kfqeof"><style data-emotion="css 1od5tk4">.css-1od5tk4{box-sizing:border-box;margin:0;min-width:0;width:100%;max-width:1024px;margin-left:auto;margin-right:auto;padding:32px;background-color:var(--theme-ui-colors-muted);}</style><div class="css-1od5tk4"><button id="scroll-btn" type="button" class="sidebar-btns" title="Scroll to top" aria-label="Scroll to top"></button><h1>Usando Spring Batch para fazer ETL de informaçoes financeiras</h1><p>February 14, 2020</p><div><style data-emotion="css tj7avn">.css-tj7avn{color:var(--theme-ui-colors-text);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;font-weight:400;line-height:1.5;}</style><p class="css-tj7avn">Comecei a brincar com Spring Batch e ETLs e isso foi o que consegui fazer (até então)….</p><p class="css-tj7avn">O ano de 2019 foi bem intenso pra mim pois tive a oportunidade de aprender muita coisa sobre desenvolvimento Web com Java Spring e cultura DevOps no geral. Mas aí é o que dizem: Quanto mais você estuda algo mais você percebe o quão ainda tem que aprender. Então lá estava eu procurando uma forma de aprofundar meus conhecimentos do ecossistema Spring, quando fiquei curioso com o projeto Spring Batch.</p><p class="css-tj7avn">Pra quem não sabe Spring Batch é um subprojeto do framework Spring destinado a fazer processamentos em lote. Este projeto possui diversas facilidades incluídas na sua toolset que permite a execução sistemática, determinística e rastreável de trabalhos executados em batches ou lotes. Um exemplo muito bacana de aplicação, é o seu uso para processar um streaming de dados tais como uma planilha ou um banco de dados. E é justamente um exemplo assim que eu vou mostrar aqui inaugurando o meu primeiro artigo for real do meu blog =D</p><p class="css-tj7avn">Na minha busca por um caso de uso bacana para entender um pouco mais o Spring Batch, e aproveitando que ano passado estava inserido no Grupo de Estudos em Ciência de Dados, um projeto de extensão da Unila que você pode conferir mais clicando neste <style data-emotion="css fmslpk">.css-fmslpk{color:#fff;-webkit-text-decoration:none;text-decoration:none;}</style><a href="https://medialabfoz.com/gecd/" class="css-fmslpk">link</a>, me deparei com o conceito de ETL.</p><style data-emotion="css net0mi">.css-net0mi{color:var(--theme-ui-colors-text);font-family:inherit;line-height:1.125;font-weight:700;font-size:24px;}</style><h2 class="css-net0mi">ELT (TL;DR)</h2><p class="css-tj7avn">Um ETL é uma sigla inglesa que significa Extract Transform e Load (Extrair, Transformar e “Carregar”). A idéia em si é muito simples e consiste em operações que envolvem grande volumes de dados compostas em basicamente em três fases: extração, transformação e carregamento (ou armazenamento). <a href="https://pt.wikipedia.org/wiki/Extract,_transform,_load" class="css-fmslpk">Definição completinha na Wikipédia</a>.</p><p class="css-tj7avn">Seu uso é muito comum quando se quer transferir um ou até mesmo vários dados de um conjunto de armazenamento para o outro. Sendo que entre origem e destino é possível fazer transformações nos dados tais como agregação, formatação e entre outros.</p><h2 class="css-net0mi">Descrição do problema que eu fui caçar</h2><p class="css-tj7avn">Com este conceito em mente, precisava de um conjunto de dados para começar. Como eu me amarro em aprender mais sobre produtos financeiros, tais como renda fixa, ações e fundos imobiliários fui procurar alguma coisa que envolvesse esses tipos de dados. Descobri que a CVM (Comissão de Valores Imobiliários) possui um <a href="http://dados.cvm.gov.br/" class="css-fmslpk">portal de dados abertos</a> onde é possível baixar as mais diversas planilhas relacionadas a fundos de investimento tais como informe diário, informações cadastrais e entre outros.</p><p class="css-tj7avn">Dentre os conjuntos de dados fornecidos pela CVM existe um denominado “Informe diário” que segundo a própria CVM tem um demonstrativo com informações como:</p><ul class="css-0"><li class="css-0">Valor total da carteira do fundo</li><li class="css-0">Patrimônio líquido</li><li class="css-0">Valor da cota</li><li class="css-0">Captações realizadas no dia</li><li class="css-0">Resgates pagos no dia</li><li class="css-0">Número de cotistas</li></ul><p class="css-tj7avn">Baixei uma planilha de um dia aleatório e boom! Um csv com mais de 200.000 linhas de dados estruturados. Perfeito para arregaçar as mangas e começar a brincar.</p><p class="css-tj7avn">Cada linha do CSV representa informações de um fundo em determinado dia. Dentre as dezenas de colunas disponibilizadas na planilha, elegi algumas para utilizar na minha solução de ETL, são elas:</p><ol class="css-0"><li class="css-0">CNPJ da empresa emissora</li><li class="css-0">Data de Referência</li><li class="css-0">Valor Total</li><li class="css-0">Valor da Quota</li><li class="css-0">Patrimônio líquido</li><li class="css-0">Captação no dia (total de depósitos)</li><li class="css-0">Resgates no dia (total de retiradas)</li><li class="css-0">Número de Quotistas</li></ol><p class="css-tj7avn">Como primeiro passo pensei em só fazer um ETL simples, ou seja carregar as informações do CSV e gravá-las em um banco de dados MySQL. Para não ficar sem fazer nenhuma mudança no passo de transformação, resolvi apenas remover a formatação do campo CNPJ, ou seja, no banco eu somente salvo os dígitos, sem pontos ou traços.</p><p class="css-tj7avn">O rascunho de guardanapo da minha solução ficou assim:</p><p class="css-tj7avn"><a href="https://i.imgur.com/4ID6lG9.png" class="css-fmslpk"><style data-emotion="css 16uw51n">.css-16uw51n{display:block;max-width:100%;margin-left:auto;margin-right:auto;}</style><img src="https://i.imgur.com/4ID6lG9.png" alt="ETLSchema" title="ETL Schema" class="css-16uw51n"/></a></p><p class="css-tj7avn">A ideia é, ler o arquivo CSV, fazer um ETL usando Spring Batch, gravar as informações em uma tabela no banco de dados usando o Spring Data, e finamente utilizar o Spring Web para disponibilizar as informações em formato JSON através de uma API.</p><p class="css-tj7avn">O esquema de dados da entidade que eu criei no banco ficou assim:</p><p class="css-tj7avn"><a href="https://i.imgur.com/Wp41TkJ.png" class="css-fmslpk"><img src="https://i.imgur.com/Wp41TkJ.png" alt="DailyInform" title="Daily Inform" class="css-16uw51n"/></a></p><p class="css-tj7avn">Apresentados a ideia e uma arquitetura geral do brincadeira, bora escrever um pouco de código!</p><h2 class="css-net0mi">Passo 1, fazendo meu “Hello World” com Spring Batch</h2><p class="css-tj7avn">Para utilizar o Spring Batch primeiro você precisa colocar as dependências dele no seu projeto. Você pode começar criando um projeto no Spring Initializr selecionando as seguintes dependências:</p><ul class="css-0"><li class="css-0">Spring boot starter data jpa: (para fazer conexão ao banco de dados)</li><li class="css-0">Spring boot starter web: (para criar a camada web responsável por expor os dados vai uma API REST com JSON).</li><li class="css-0">mySql-connector-java: Para este tutorial eu optei por utilizar o MySQL, mas qualquer outro DB relacional funciona.</li><li class="css-0">spring-boot-starter-batch: A estrelinha do projeto, contém as classes necessárias para utilizar o Spring Batch.</li></ul><p class="css-tj7avn"><a href="https://i.imgur.com/SwwyBT1.png" class="css-fmslpk"><img src="https://i.imgur.com/SwwyBT1.png" alt="SpringInitializr" title="Spring Initializr" class="css-16uw51n"/></a></p><p class="css-tj7avn">Uma vez baixado o zip é só descompactar, abrir na sua IDE favorita e começar a codar!</p><p class="css-tj7avn">Primeiramente é necessário criar a Entidade DailyInform, que será o objeto final que as informações de planilha serão convertidas e gravadas no Banco:</p><deckgo-highlight-code language="java">
          <style data-emotion="css 1q7q4hh">.css-1q7q4hh{font-family:Menlo,monospace;font-size:inherit;}</style><code slot="code" class="css-1q7q4hh">import javax.persistence.*;
import javax.validation.constraints.NotNull;
import java.io.Serializable;
import java.math.BigDecimal;
import java.time.LocalDate;

@Entity
@Table(indexes = {
       @Index(columnList = &quot;cnpj&quot;, name = &quot;cnpj_hidx&quot;),
       @Index(columnList = &quot;referenceDate&quot;, name = &quot;reference_date_hidx&quot;)},
       uniqueConstraints = @UniqueConstraint(columnNames = { &quot;cnpj&quot;, &quot;referenceDate&quot; }))
public class DailyInform implements Serializable {

   @Id
   @GeneratedValue(strategy = GenerationType.AUTO)
   private Long id;

   @NotNull
   @CNPJ
   @Column(nullable = false)
   private String cnpj;

   @NotNull
   @Column(nullable = false)
   private LocalDate referenceDate;

   @NotNull
   @Column(nullable = false)
   private BigDecimal totalValue;

   @NotNull
   @Column(nullable = false)
   private BigDecimal quotaValue;

   @NotNull
   @Column(nullable = false)
   private BigDecimal netWorth;

   @NotNull
   @Column(nullable = false)
   private BigDecimal totalDeposits;

   @NotNull
   @Column(nullable = false)
   private BigDecimal totalWithdrawals;

   @NotNull
   @Column(nullable = false)
   private Long numberOfQuotaHolders;

   public DailyInform() {};

   public DailyInform(String cnpj, LocalDate referenceDate,
                      BigDecimal totalValue, BigDecimal quotaValue,
                      BigDecimal netWorth, BigDecimal totalDeposits,
                      BigDecimal totalWithdrawals, Long numberOfQuotaHolders) {
       this.cnpj = cnpj;
       this.referenceDate = referenceDate;
       this.totalValue = totalValue;
       this.quotaValue = quotaValue;
       this.netWorth = netWorth;
       this.totalDeposits = totalDeposits;
       this.totalWithdrawals = totalWithdrawals;
       this.numberOfQuotaHolders = numberOfQuotaHolders;
   }

   @Override
   public String toString() {
       return &quot;DailyInform{&quot; +
               &quot;cnpj=&#x27;&quot; + cnpj + &#x27;\&#x27;&#x27; +
               &quot;, referenceDate=&quot; + referenceDate +
               &quot;, quotaValue=&quot; + quotaValue +
               &#x27;}&#x27;;
   }
   // .... Getters/Setters
}</code>
        </deckgo-highlight-code><p class="css-tj7avn">Observe que é uma Entidade JPA bem simples só para ilustrar os conceitos. Também adicionei alguns índices para melhorar o desempenho de queries de busca.</p><p class="css-tj7avn">Os processamentos em lote no Spring são executados através de um Job. Um job é composto de Steps que definem passos sucessivos de leitura, transformação e escrita (para este tutorial faremos um Job com um único Step). O Step basicamente tem três elementos:</p><ol class="css-0"><li class="css-0">Um reader: Define o que e como vai ser lido. Nesta fase que se define de onde virão os dados (no caso a planilha), e quais colunas serão digeridas.</li><li class="css-0">Um processor: Define uma operação de transformação que o dado lido terá que sofrer até estar pronto para a escrita. Recebe um objeto de entrada e retorna outro objeto de saída.</li><li class="css-0">Um writer: Define onde os dados recém processados serão escritos, neste artigo iremos utilizar um Repository bean para escrever as informações na tabela do banco de dados.</li></ol><p class="css-tj7avn">Para utilizar um Job no SpringBatch é necessário configurá-lo. Segue um exemplo de um trecho do arquivo @Configuration(lembrando que o código completo deste tutorial encontra-se no meu GitHub:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@Configuration
@EnableBatchProcessing
public class SpringBatchConfiguration {

   @Bean
   public Job job(JobBuilderFactory jobBuilderFactory,
                  StepBuilderFactory stepBuilderFactory,
                  ItemReader&lt;DailyInform&gt; itemReader,
                  ItemProcessor&lt;DailyInform, DailyInform&gt; itemProcessor,
                  ItemWriter&lt;DailyInform&gt; itemWriter) {

       Step step = stepBuilderFactory.get(&quot;ETL-file-load&quot;)
               .&lt;DailyInform, DailyInform&gt;chunk(1000)
               .reader(itemReader)
              .processor(itemProcessor)
               .writer(itemWriter)
               .build();

       return jobBuilderFactory.get(&quot;ETL-Load&quot;)
                               .incrementer(new RunIdIncrementer())
                               .start(step)
                               .build();
   }
   // mais beans virão
}
</code>
        </deckgo-highlight-code><p class="css-tj7avn">Como pode ser visto na linha 25, é necessário utilizar a annotation <code class="css-0">@EnableBatchProcessing</code> para habilitar o Spring Batch no projeto. O Job é exposto para aplicação através de um bean, sendo gerenciado pelo Spring Container. O método <code class="css-0">job</code> recebe cinco parâmetros: <code class="css-0">jobBuilderFactory</code>, <code class="css-0">stepBuilderFactory</code>, <code class="css-0">itemReader</code>, <code class="css-0">itemProcessor</code>, <code class="css-0">itemWriter</code>. As factories são injetadas pelo próprio Spring, ao passo que cabe a nós definir os outros parâmetros através de Beans na aplicação. Uma vez definidos, o próprio Spring os injeta no método e cria o <code class="css-0">Job</code>. Observe que os tipos do reader, processor e writer são tipados de acordo com a entidade modelada <code class="css-0">DailyInform</code>. É perfeitamente possível modelar um fluxo onde a leitura é de um tipo, convertido a outro no processamento e depois gravado no estágio de escrita. Mas para manter este tutorial mais simples vamos seguir com a idéia de manter o mesmo tipo durante todo o ciclo.</p><p class="css-tj7avn">Graças a injeção de dependência, o Spring consegue montar o Job utilizando um reader, processor e writer que também são Beans na aplicação. Vou explicar como eles são criados e o detalhamento de cada um deles nas sessões a seguir.</p><h2 class="css-net0mi">Passo 2 - Criando o bean de leitura</h2><p class="css-tj7avn">Podemos criar um bean de leitura a partir da classe <code class="css-0">FlatFileItemReader&lt;T&gt;</code>, uma classe que implementa indiretamente a interface <code class="css-0">ItemReader&lt;T&gt;</code>. A facilidade de usar esta classe é que ela foi projetada para cenários de leituras em arquivos linha a linha (perfeito para o nosso exemplo de CSV). A sua configuração é relativamente simples, no entanto ela exige a criação de outro bean auxiliar. Segue um exemplo da implementação:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@Bean
public FlatFileItemReader&lt;DailyInform&gt; fileItemReader(@Value(&quot;${input}&quot;) Resource resource) {
   FlatFileItemReader&lt;DailyInform&gt; fileItemReader = new FlatFileItemReader&lt;&gt;();
   fileItemReader.setResource(resource);
   fileItemReader.setEncoding(&quot;ISO-8859-3&quot;);
   fileItemReader.setName(&quot;CSV-Reader&quot;);
   fileItemReader.setLinesToSkip(1);
   fileItemReader.setLineMapper(lineMapper());
   return fileItemReader;
}</code>
        </deckgo-highlight-code><p class="css-tj7avn">Em que:</p><p class="css-tj7avn">Entrada: Resource (uma referência ao arquivo .csv), aqui eu setei o path em uma variável de ambiente <code class="css-0">${input}</code> por conveniência.</p><p class="css-tj7avn">Saída: Um objeto do tipo <code class="css-0">FlatFileItemReader&lt;DailyInform&gt;</code> onde eu configuro:</p><ul class="css-0"><li class="css-0">O recurso que será lido.</li><li class="css-0">O encoding do arquivo, no caso eu descobri que a planilha baixada não está em UTF-8, logo eu precisei informar o encoding correto para não haver falhas de leitura de caracteres especiais tais como à ó ã (Português né ?).</li><li class="css-0">Nome deste bean: provavelmente utilizado pelo Spring para uma indexação interna deste reader.</li><li class="css-0">Linhas para pular: Coloquei o valor 1 para pular o cabeçalho e ir direto para os dados.</li><li class="css-0">O <code class="css-0">LineMapper</code>: O bean auxiliar necessário para configurar as políticas de leitura. Sua criação será detalhada a seguir.</li></ul><style data-emotion="css 14j2joi">.css-14j2joi{color:var(--theme-ui-colors-text);font-family:inherit;line-height:1.125;font-weight:700;font-size:20px;}</style><h3 class="css-14j2joi">Criando o LineMapper</h3><p class="css-tj7avn">O <code class="css-0">LineMapper</code> é o bean que basicamente define qual vai ser a lógica de leitura tais como: Qual caractere é o delimitador de colunas, qual é o nome das colunas e como converter a linha lida em objeto. Sua construção se dá da seguinte forma:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@Bean
public LineMapper&lt;DailyInform&gt; lineMapper() {
   DefaultLineMapper&lt;DailyInform&gt; defaultLineMapper = new DefaultLineMapper&lt;&gt;();
   DelimitedLineTokenizer lineTokenizer = new DelimitedLineTokenizer();

   lineTokenizer.setDelimiter(&quot;;&quot;);

   lineTokenizer.setNames(&quot;CNPJ_FUNDO&quot;,
                          &quot;DT_COMPTC&quot;,
                          &quot;VL_TOTAL&quot;,
                          &quot;VL_QUOTA&quot;,
                          &quot;VL_PATRIM_LIQ&quot;,
                          &quot;CAPTC_DIA&quot;,
                          &quot;RESG_DIA&quot;,
                          &quot;NR_COTST&quot;);
   lineTokenizer.setStrict(false);

   DailyInformFieldSetMapper dailyInformFieldSetMapper = new DailyInformFieldSetMapper();

   defaultLineMapper.setLineTokenizer(lineTokenizer);
   defaultLineMapper.setFieldSetMapper(dailyInformFieldSetMapper);

   return defaultLineMapper;
}
</code>
        </deckgo-highlight-code><p class="css-tj7avn">O objeto retornado por este método é uma instância da classe <code class="css-0">DefaultLineMapper</code>, que implementa a interface <code class="css-0">LineMapper</code>, onde é configurado:</p><ul class="css-0"><li class="css-0">O delimitador: no caso do CSV da CVM foi utilizado o caractere ‘;’ para separar os dados de cada coluna</li><li class="css-0">Define os tokens (ou os nomes) de cada coluna que será lida, bem como a quantas serão processadas. Mais tarde estes nomes serão utilizados no bean que coloca as informações de cada linha em um objeto POJO DailyInform.</li><li class="css-0">Setar leitura estrita: Caso seja true toda linha lida deve ter o número correto de colunas, se for marcada como false o SpringBatch aceita a leitura de linhas que não possui o mesmo número de colunas definidos nos tokens. Caso haja menos colunas, os valores que faltam serão preenchidos com empty(vazio), caso haja mais colunas elas serão simplesmente ignoradas.</li><li class="css-0">O <code class="css-0">fieldsetmapper</code>: Bean que define como os dados lidos das linhas serão convertidos em um POJO. Neste caso eu criei uma classe chamada DailyInformFieldSetMapper que faz este trabalho.</li></ul><h3 class="css-14j2joi">O DailyInformFieldSetMapper (pois aqui não existe mágica)</h3><p class="css-tj7avn">Esta classe implementa a interface <code class="css-0">FieldSetMapper&lt;T&gt;</code>, que por contrato obriga a implementar o método <code class="css-0">&lt;T&gt; mapFieldSet(FieldSet fieldSet)</code>, este método recebe por parâmetro uma linha lida pelo <code class="css-0">LineMapper</code> e é nele que se implementa a lógica de colocar os tokens definidos em atributos da classe <code class="css-0">DailyInform</code>. Esse é o coração da conversão do dado que está em uma linha CSV para um objeto Java completo (por isso que eu digo que aqui não existe mágica xD). A classe só tem o méotodo <code class="css-0">mapFieldSet</code> e fica desta forma:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">public class DailyInformFieldSetMapper implements FieldSetMapper&lt;DailyInform&gt; {

   @Override
   public DailyInform mapFieldSet(FieldSet fieldSet) throws BindException {
       final DailyInform dailyInform = new DailyInform();
       dailyInform.setCnpj(fieldSet.readString(&quot;CNPJ_FUNDO&quot;));
       dailyInform.setReferenceDate(fieldSet.readDate(&quot;DT_COMPTC&quot;)
                  .toInstant().atZone(ZoneId.systemDefault()).toLocalDate());
       dailyInform.setTotalValue(fieldSet.readBigDecimal(&quot;VL_TOTAL&quot;));
       dailyInform.setQuotaValue(fieldSet.readBigDecimal(&quot;VL_QUOTA&quot;));
       dailyInform.setNetWorth(fieldSet.readBigDecimal(&quot;VL_PATRIM_LIQ&quot;));
       dailyInform.setTotalDeposits(fieldSet.readBigDecimal(&quot;CAPTC_DIA&quot;));
       dailyInform.setTotalWithdrawals(fieldSet.readBigDecimal(&quot;RESG_DIA&quot;));
       dailyInform.setNumberOfQuotaHolders(fieldSet.readLong(&quot;NR_COTST&quot;));
       return dailyInform;
   }
}
</code>
        </deckgo-highlight-code><p class="css-tj7avn">Feito isso, tudo está pronto e configurado para o passo de leitura, agora só falta os passos de transformação e escrita, mas felizmente eles são bem mais simples de fazer conforme eu vou mostrar agora.</p><h2 class="css-net0mi">Parte 3 - Configurando o Processor</h2><p class="css-tj7avn">A classe <code class="css-0">DailyInformProcessor</code> é a classe responsável por realizar operações de transformação no objeto <code class="css-0">DailyInform</code>. É neste estágio que pode-se fazer as mais completas operações tais como aplicar cálculos, fazer formatações, agregar dados e até mesmo converter a saída para um outro objeto completamente diferente. No caso deste tutorial, para ilustrar o seu uso eu utilizei este passo para formatar o valor do CNPJ das empresas ao remover pontos e traços. Para isso, peguei uma ajudinha na biblioteca da <a href="http://stella.caelum.com.br/" class="css-fmslpk">Alura Stella</a>, que contém diversas facilidades para manipular documentos brazucas. Além disso, não modifiquei o tipo de objeto de saída (entra <code class="css-0">DailyInform</code>, sai <code class="css-0">DailyInform</code>). A classe tem implementação simples e ficou da seguinte maneira:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@Component
public class DailyInformProcessor implements ItemProcessor&lt;DailyInform, DailyInform&gt; {

   @Autowired
   private CNPJFormatter cnpjFormatter;

   @Override
   public DailyInform process(DailyInform dailyInform) throws Exception {
       dailyInform.setCnpj(cnpjFormatter.unformat(dailyInform.getCnpj()));
       return dailyInform;
   }
}
</code>
        </deckgo-highlight-code><p class="css-tj7avn">Observe que é necessário implementar o método <code class="css-0">process</code> da interface <code class="css-0">ItemProcessor</code>, bem auto explicativo.</p><p class="css-tj7avn">Por último só faltou implementar o estágio da escrita.</p><h2 class="css-net0mi">Parte 4 - Configurando a Escrita</h2><p class="css-tj7avn">Primeiramente, vamos criar um repositório para a entidade <code class="css-0">DailyInform</code> que será utilizado pelo <code class="css-0">Writer</code> para escrever os dados no DB.</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@Repository
public interface DailyInformRepository extends JpaRepository&lt;DailyInform, Long&gt; {
   List&lt;DailyInform&gt; findDistinctByCnpj(String cnpj);
}
</code>
        </deckgo-highlight-code><p class="css-tj7avn">É um repositório simples utilizando Spring Data sem muito mistério. Só adicionei um método para achar os informes diários via CNPJ pois eu criei um endpoint na camada web que traz os resultados por empresa.</p><p class="css-tj7avn">Feito o repositório, agora é só criar o <code class="css-0">Writer</code>, que basicamente é um componente Spring que implementa a inteface <code class="css-0">ItemWriter</code>:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@Component
public class DBWriter implements ItemWriter&lt;DailyInform&gt; {

   private final DailyInformRepository dailyInformRepository;

   @Autowired
   public DBWriter(DailyInformRepository dailyInformRepository) {
       this.dailyInformRepository = dailyInformRepository;
   }

   @Override
   public void write(List&lt;? extends DailyInform&gt; list) {
       dailyInformRepository.saveAll(list);
   }
}
</code>
        </deckgo-highlight-code><p class="css-tj7avn">O único método que o a interface impõe implementar o é o <code class="css-0">write</code>. Este por sua vez recebe uma lista com dados (os chunks que são transformados no passo anterior), que por sua vez eu mando escrever no banco utilizando o <code class="css-0">DailyInformRepository</code>, injetado aqui na classe como um atributo chamado <code class="css-0">dailyInformRepository</code>. As JpaRepositories possuem um método chamado <code class="css-0">saveAll</code> onde se passa uma collection Java que será salva no banco, feito isso aquelas informações são persistidas e nossos dados finalmente chegam ao seu destino final =D</p><h2 class="css-net0mi">Bônus - Camada Web</h2><p class="css-tj7avn">Uma vez que os dados foram salvos no banco de dados, é bem tranquilo fazer uma camada web para expor as informações em formato JSON. Se você é bem tradicional e quer seguir a arquitetura N-camadas, pode fazer uma Service um Controller. Os trechos de código abaixo ilustram como fazer isso:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@Service
public class FundsService {

   private final DailyInformRepository dailyInformRepository;

   @Autowired
   public FundsService(DailyInformRepository dailyInformRepository) {
       this.dailyInformRepository = dailyInformRepository;
   }

   @Transactional(readOnly = true)
   public List&lt;DailyInform&gt; getDailyInformByCNPJ(String cnpj) {
       return dailyInformRepository.findDistinctByCnpj(cnpj);
   }
}</code>
        </deckgo-highlight-code><p class="css-tj7avn">E a controller:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@RestController
@RequestMapping(&quot;/api/daily-informs&quot;)
public class FundsController {

   private final FundsService fundsService;

   @Autowired
   public FundsController(FundsService fundsService) {
       this.fundsService = fundsService;
   }

   @GetMapping(&quot;/{cnpj}&quot;)
   public ResponseEntity&lt;List&lt;DailyInform&gt;&gt; all(@PathVariable(&quot;cnpj&quot;) String cnpj) {
       return ResponseEntity.of(Optional.of(fundsService.getDailyInformByCNPJ(cnpj)));
   }
}
</code>
        </deckgo-highlight-code><p class="css-tj7avn">Sobre estes dois componentes tenho as seguintes considerações:</p><ol class="css-0"><li class="css-0">Repare que eu injeto o repositório no serviço, e o serviço na controller. Seguindo os preceitos de arquitetura em camadas e expondo a camada de dados somente via serviços.</li><li class="css-0">Em <code class="css-0">FundsService</code> eu coloquei a annotation <code class="css-0">@Transaction</code> com o parâmetro readonly para true, desta forma eu informo para o Spring abrir um contexto transacional deste método e que não vou fazer operações de escrita e remoção no banco de dados, unindo controle transacional com um ganho de performance.</li><li class="css-0">Na controller resolvi utilizar o CNPJ como um <code class="css-0">PathParam</code>, mas existem outras formas que isso pode ser feito (através de uma queryParam obrigatória por exemplo).</li><li class="css-0">Por fim eu injetei todos os componentes através de construtores de classe, gosto de fazer assim pois consigo declarar minhas dependências como final, deixando os atributos da classe mais imutáveis.</li></ol><h2 class="css-net0mi">Botanto para Rodar!</h2><p class="css-tj7avn">Feito tudo agora chegou a hora de rodar esse batch. Pra rodar o job assim que o Spring startar eu implementei a interface <code class="css-0">CommandLineRunner</code> na classe principal que executa o job configurado. O resultado fica assim:</p><deckgo-highlight-code language="java">
          <code slot="code" class="css-1q7q4hh">@SpringBootApplication
public class BatchProcessingApplication implements CommandLineRunner {

   @Bean
   public CNPJFormatter cnpjFormatter() {
       return new CNPJFormatter();
   }

   @Autowired
   private JobLauncher jobLauncher;

   @Autowired
   private Job job;

   public static void main(String[] args) {
       SpringApplication.run(BatchProcessingApplication.class, args);
   }

   @Override
   public void run(String... args) throws Exception {
       jobLauncher.run(job, new JobParameters());
   }
}
</code>
        </deckgo-highlight-code><p class="css-tj7avn">O bean <code class="css-0">Job</code> é detectado pelo Spring e ele vem lá do <code class="css-0">Job</code> que criamos no arquivo de configuração, além disso, precisamos de um <code class="css-0">JobLaucher</code> que nada mais é um do que um bean provido pelo Spring para fazer o lançamento do seu job. Fazemos isso colocando o atributo job dentro do método run do <code class="css-0">jobLauncher</code>. O parâmetro <code class="css-0">JobParameters</code> é basicamente um Wrapper de um <code class="css-0">Map&lt;String, Object&gt;</code> que te permite passar parâmetros para o job que vai rodar (não vamos utilizar isto neste tutorial, logo podemos passar uma instância vazia).</p><p class="css-tj7avn">Fazendo isso dando play (certifque-se que os seu banco de dados está de pé e acessível da sua aplicação) podemos ver os jobs rodando…..</p><p class="css-tj7avn">E aqui na minha máquina demorou mais ou menos uma hora e meia para processar as 200 mil linhas de dados.</p><p class="css-tj7avn"><a href="https://i.imgur.com/gIyfW6P.png" class="css-fmslpk"><img src="https://i.imgur.com/gIyfW6P.png" alt="Resultados Cmd" title="Resultados em execução" class="css-16uw51n"/></a></p><p class="css-tj7avn">O banco de dados ficou assim:</p><p class="css-tj7avn"><a href="https://i.imgur.com/jf34chM.png" class="css-fmslpk"><img src="https://i.imgur.com/jf34chM.png" alt="Resultados BD" title="Resultados no banco" class="css-16uw51n"/></a></p><p class="css-tj7avn">E este é o resultado usando o endpoint que criei pra trazer os resultados por CNPJ, bacana não ? XD</p><p class="css-tj7avn"><a href="https://i.imgur.com/XmSLgAA.png" class="css-fmslpk"><img src="https://i.imgur.com/XmSLgAA.png" alt="Resultados JSON" title="Resultados JSON" class="css-16uw51n"/></a></p><h2 class="css-net0mi">Conclusão</h2><p class="css-tj7avn">Wow se você chegou até aqui meus parabéns! Hehehe este tutorial ficou bem maior do que eu esperava, mas tá ótimo pra começar este blog com o pé direito. É óbvio que tem bastante coisa pra melhorar, mas agora eu tenho um norte e espero fazer pelo menos 2 artigos novos aqui por mês.</p><p class="css-tj7avn">Quanto a solução, bom funcionou, mas eu creio que existem bastante pontos de melhoria. Algumas coisas eu já descobri que dá pra melhorar e posso falar um pouco mais em um próximo artigo. Um exemplo é que se houver alguma linha com informações irregulares na planilha, todo o job para. Como isso não é desejável, precisamos definir uma política de tolerância e registro de erros. Outra coisa que também é possível fazer é paralelizar a execução, como deixar o processamento de forma mais eficiente ? Será que tem que fazer alguma configuração a mais no banco ? Fique ligado para mais conteúdo vindo por aí.</p><p class="css-tj7avn">Espero que tenham gostado deste meu primeiro artigo e peço pra que você compartilhe com os seus colegas. Sinta-se livre para fazer observações nos comentários, quanto mais feedback receber melhor!</p><p class="css-tj7avn"><a href="https://github.com/lcastrooliveira/funds_daily_report" class="css-fmslpk">GitHub da solução</a></p><h3 class="css-14j2joi">Referências</h3><p class="css-tj7avn">Para mais referências visite os seguintes sites. Foram deles que eu me baseei pra fazer este tutorial:</p><ul class="css-0"><li class="css-0"><a href="https://maven.apache.org/guides/index.html" class="css-fmslpk">Official Apache Maven documentation</a></li><li class="css-0"><a href="https://docs.spring.io/spring-boot/docs/2.2.1.RELEASE/maven-plugin/" class="css-fmslpk">Spring Boot Maven Plugin Reference Guide</a></li><li class="css-0"><a href="https://docs.spring.io/spring-boot/docs/2.2.1.RELEASE/reference/htmlsingle/#howto-batch-applications" class="css-fmslpk">Spring Batch</a></li></ul><h3 class="css-14j2joi">Guia</h3><p class="css-tj7avn">Este guia também é muito bom e é do próprio Spring, recomendo para quem quer aprender mais.</p><ul class="css-0"><li class="css-0"><a href="https://spring.io/guides/gs/batch-processing/" class="css-fmslpk">Creating a Batch Service</a></li></ul><p class="css-tj7avn">Abraços;</p></div><div id="disqus_thread"></div></div></main><div class="css-1tsye3q"><style data-emotion="css 1tg3sbe">.css-1tg3sbe{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding:8px;}</style><footer class="css-1tg3sbe"><div class="css-1sg9vzq">© 2022 Lucas de Castro Oliveira</div></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/2020/2020-02-14-spring-batch/index.pt/";window.___webpackCompilationHash="a2bfc391596ce2bee280";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-767cf05b533a4ae9d406.js"],"app":["/app-bad2ce8103fa8906b2df.js"],"component---src-components-tags-js":["/component---src-components-tags-js-463866e5df0a73eca154.js"],"component---src-pages-404-js":["/component---src-pages-404-js-b42cb2d01a2656dac3e9.js"],"component---src-pages-about-js":["/component---src-pages-about-js-11c61deeec6e9aa0a4d2.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-b4d83b9fa6801dc85b3f.js"],"component---src-pages-index-js":["/component---src-pages-index-js-420fb1381101f134fb4a.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-71294668d60ece1fd9e1.js"],"component---src-templates-post-page-template-js":["/component---src-templates-post-page-template-js-1473b82cdc2fba7001af.js"]};/*]]>*/</script><script src="/polyfill-767cf05b533a4ae9d406.js" nomodule=""></script><script src="/component---src-templates-post-page-template-js-1473b82cdc2fba7001af.js" async=""></script><script src="/95d32b32e96a6247500d795b14d67e6354a04d89-f51203b5a3fe19078cf0.js" async=""></script><script src="/99b7119fd52cd3d90c1cdad208f938f090fd7adb-5239dbe11e8a53b8d362.js" async=""></script><script src="/app-bad2ce8103fa8906b2df.js" async=""></script><script src="/dbf3ce33-e9860c7ab2c3d4ec26ae.js" async=""></script><script src="/framework-d48bb74d9b35d2fed097.js" async=""></script><script src="/webpack-runtime-559f8e6fdcf32331fb71.js" async=""></script></body></html>